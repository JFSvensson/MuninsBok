// Prisma schema for Munins bok
// Swedish bookkeeping application with multi-tenant support

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ORGANIZATION (tenant)
// ============================================

model Organization {
  id                   String   @id @default(cuid())
  orgNumber            String   @unique @map("org_number")
  name                 String
  fiscalYearStartMonth Int      @default(1) @map("fiscal_year_start_month")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  fiscalYears FiscalYear[]
  accounts    Account[]
  vouchers    Voucher[]
  documents   Document[]

  @@map("organizations")
}

// ============================================
// FISCAL YEAR
// ============================================

model FiscalYear {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  startDate      DateTime @map("start_date")
  endDate        DateTime @map("end_date")
  isClosed       Boolean  @default(false) @map("is_closed")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vouchers     Voucher[]

  @@unique([organizationId, startDate])
  @@map("fiscal_years")
}

// ============================================
// ACCOUNT (chart of accounts per org)
// ============================================

model Account {
  id             String      @id @default(cuid())
  organizationId String      @map("organization_id")
  number         String
  name           String
  type           AccountType
  isVatAccount   Boolean     @default(false) @map("is_vat_account")
  isActive       Boolean     @default(true) @map("is_active")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  voucherLines VoucherLine[]

  @@unique([organizationId, number])
  @@map("accounts")
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

// ============================================
// VOUCHER (verifikat)
// ============================================

model Voucher {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  fiscalYearId   String   @map("fiscal_year_id")
  number         Int
  date           DateTime
  description    String
  createdBy      String?  @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Correction: this voucher corrects another voucher
  correctsVoucherId   String?  @unique @map("corrects_voucher_id")
  correctsVoucher     Voucher? @relation("VoucherCorrection", fields: [correctsVoucherId], references: [id])
  correctedByVoucher  Voucher? @relation("VoucherCorrection")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fiscalYear   FiscalYear    @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  lines        VoucherLine[]
  documents    Document[]

  @@unique([fiscalYearId, number])
  @@index([organizationId])
  @@index([date])
  @@map("vouchers")
}

// ============================================
// VOUCHER LINE (verifikatrad)
// ============================================

model VoucherLine {
  id            String  @id @default(cuid())
  voucherId     String  @map("voucher_id")
  accountId     String  @map("account_id")
  accountNumber String  @map("account_number")
  debit         Int     @default(0)
  credit        Int     @default(0)
  description   String?

  // Relations
  voucher Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([voucherId])
  @@index([accountNumber])
  @@map("voucher_lines")
}

// ============================================
// DOCUMENT (attached files)
// ============================================

model Document {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  voucherId      String?  @map("voucher_id")
  filename       String
  mimeType       String   @map("mime_type")
  storageKey     String   @map("storage_key")
  size           Int
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  voucher      Voucher?     @relation(fields: [voucherId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([voucherId])
  @@map("documents")
}
